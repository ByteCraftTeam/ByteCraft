# ByteCraft 调试指南

## Agent消息调试功能

为了帮助开发者和用户了解ByteCraft内部的消息处理流程，我们添加了详细的调试日志功能。

### 启用调试模式

设置环境变量 `DEBUG_AGENT_MESSAGES=true` 来启用调试输出：

```bash
# Linux/macOS
export DEBUG_AGENT_MESSAGES=true
craft "你好"

# Windows
set DEBUG_AGENT_MESSAGES=true
craft "你好"

# 或者直接在命令行中使用
DEBUG_AGENT_MESSAGES=true craft "你好"
```

### 调试输出内容

启用调试模式后，您将看到以下详细信息：

#### 1. 历史消息加载调试 🔍
```
🔍 [DEBUG] 历史消息加载完成：
   会话ID: xxx-xxx-xxx
   历史消息数量: 5
   历史消息概要:
     1. [user] 你好，帮我分析一下这个项目的结构... (2025-06-27T10:00:00.000Z)
     2. [assistant] 我来帮您分析项目结构。首先让我查看项目的整体... (2025-06-27T10:00:05.000Z)
     ...
```

#### 2. 上下文优化结果调试 🔍
```
🔍 [DEBUG] 上下文优化完成：
   优化后消息数量: 4
   优化后消息详情:
     1. [system] 你是一个AI助手，专门帮助用户进行代码开发和技术分析...
     2. [human] 你好，帮我分析一下这个项目的结构
     3. [ai] 我来帮您分析项目结构。首先让我查看项目的整体目录结构...
     4. [human] 现在我想要调试一下看看每次传给agent的内容都是哪些
```

#### 3. 最终消息数组构建调试 🔍
```
🔍 [DEBUG] 最终消息数组构建完成：
   总消息数: 5
   消息结构:
     1. [system] 你是一个AI助手，专门帮助用户进行代码开发和技术分析...
     2. [human] 你好，帮我分析一下这个项目的结构
     3. [ai] 我来帮您分析项目结构...
     4. [human] 现在我想要调试一下看看每次传给agent的内容都是哪些

   📝 完整消息内容:
     1. [system]:
        你是一个AI助手，专门帮助用户进行代码开发和技术分析。
        你的主要职责是：
        1. 分析代码结构和逻辑
        2. 提供技术建议和最佳实践
        ...

     2. [human]:
        你好，帮我分析一下这个项目的结构
     
     ...
```

#### 4. 工作流调用前参数调试 🔍
```
🔍 [DEBUG] 工作流调用前参数：
   会话ID: xxx-xxx-xxx
   消息数量: 5
   递归限制: 25
   回调管理器: 自定义回调

   📤 传递给LangGraph的完整消息参数:
   {
     "messages": [
       {
         "content": "你是一个AI助手...",
         "_getType": "system"
       },
       {
         "content": "你好，帮我分析一下这个项目的结构",
         "_getType": "human"
       },
       ...
     ]
   }
```

### 调试信息说明

- **历史消息加载**: 显示从JSONL文件中加载的原始会话历史
- **上下文优化**: 显示经过策划过滤和智能截断后的消息
- **最终消息数组**: 显示构建给AI模型的完整消息结构，包括系统提示词
- **工作流参数**: 显示传递给LangGraph工作流的完整JSON参数

### 调试流程说明

ByteCraft的消息处理流程如下：

```
用户输入 → JSONL存储 → 历史加载 → 上下文优化 → 消息构建 → 工作流调用 → AI响应
    ↓          ↓           ↓          ↓          ↓          ↓
  立即保存   缓存机制    策划过滤    截断处理   系统提示词   LangGraph
```

### 注意事项

1. **性能影响**: 调试模式会输出大量日志，可能影响性能
2. **敏感信息**: 调试输出可能包含完整的对话内容，请注意保护隐私
3. **生产环境**: 不建议在生产环境中启用调试模式
4. **日志大小**: 长对话的调试输出可能很大，建议重定向到文件

### 使用示例

```bash
# 启用调试并保存到文件
DEBUG_AGENT_MESSAGES=true craft "分析代码" 2>&1 | tee debug.log

# 只查看特定部分的调试信息
DEBUG_AGENT_MESSAGES=true craft "测试" 2>&1 | grep "🔍 \[DEBUG\]"
```

这个调试功能将帮助您深入了解ByteCraft的内部工作机制，方便进行问题诊断和性能优化。